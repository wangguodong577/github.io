

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    
    <meta name="author" content="Guodong">
    
    <meta name="description" content="本文介绍一些java数字运算的问题，通过阅读，希望你能清晰的了解java的数字运算。">
    
    

    
    <link rel="alternative" href="YOUR_RSS_ADDRESS" title="Guodong" type="application/atom+xml">
    
    
    

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>数字运算那些事 | Guodong</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css">

    <!-- Javascript -->
    <script src="/js/jquery-2.1.0.min.js"></script>
    <script src="/js/jquery.backstretch.min.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>
    <script src="/js/headroom.min.js"></script>
    <script src="/js/jquery.headroom.min.js"></script> 
    <script src="/js/common.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-inverse" role="banner">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://wangguodong577.github.io" title="Guodong">Guodong</a>
            </div>

            <div role="navigation" class="collapse navbar-collapse bs-navbar-collapse">
                

                <ul class="nav navbar-nav">
                    
                    <li id="nav-index"><a href="/">首页</a></li>
                    
                    <li id="nav-categories"><a href="/categories">分类</a></li>
                    
                    
                    <li><a href="https://github.com/wangguodong577" target="_blank">GitHub</a></li>
                </ul>
            </div>
        </div>
    </nav>
    
    <script>
    var backRoot = "/images/background/";
    var backArray = [  ];
        
    $(function() {
        // page-id...
        var pageId = "2016/05/21/数字运算那些事/";
        pageId = pageId.substr(0, pageId.indexOf("/"));
        if(pageId === "") pageId = "index";
        
        $("#nav-" + pageId).addClass("active");
    });
    </script>

    <article class="post container">
    <div class="well post-body first-post last-post">
        <h1>数字运算那些事</h1>
        
        <div class="time-info">
发表于:<time datetime="2016-05-21T07:55:01.000Z" itemprop="datePublished">2016-05-21</time>，更新于:<time datetime="2016-05-21T08:44:21.000Z" itemprop="dateModified">2016-05-21</time>，By <a href="http://wangguodong577.github.io" title="Guodong">Guodong</a>
        </div>
        
        <div class="post-body-inner">
            <div id="toc" class="toc-article well">
                <strong class="toc-title">大纲</strong>
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#假设你遇到了下面的笔试题"><span class="toc-number">1.</span> <span class="toc-text">假设你遇到了下面的笔试题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编译"><span class="toc-number">2.</span> <span class="toc-text">编译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#字节码"><span class="toc-number">3.</span> <span class="toc-text">字节码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol>
            </div>
            
            <p>本文介绍一些java数字运算的问题，通过阅读，希望你能清晰的了解java的数字运算。<br><a id="more"></a></p>
<h2 id="假设你遇到了下面的笔试题"><a href="#假设你遇到了下面的笔试题" class="headerlink" title="假设你遇到了下面的笔试题"></a>假设你遇到了下面的笔试题</h2><p>假设你遇到了下面的笔试题，你会给出什么答案。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestInteger</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Integer a = <span class="number">1</span>;</span><br><span class="line">        Integer b = <span class="number">2</span>;</span><br><span class="line">        Integer c = <span class="number">3</span>;</span><br><span class="line">        Integer d = <span class="number">3</span>;</span><br><span class="line">        Integer e = <span class="number">321</span>;</span><br><span class="line">        Integer f = <span class="number">321</span>;</span><br><span class="line">        Long g = <span class="number">3L</span>;</span><br><span class="line">        System.out.println(c == d);</span><br><span class="line">        System.out.println(e == f);</span><br><span class="line">        System.out.println(c == (a+b));</span><br><span class="line">        System.out.println(c.equals(a+b));</span><br><span class="line">        System.out.println(g == (a+b));</span><br><span class="line">        System.out.println(g.equals(a+b));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>要得到正确结果，不了解java文件的编译和字节码技术，是不可能彻底明白的。</p>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestInteger</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestInteger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Integer a = Integer.valueOf(<span class="number">1</span>);</span><br><span class="line">        Integer b = Integer.valueOf(<span class="number">2</span>);</span><br><span class="line">        Integer c = Integer.valueOf(<span class="number">3</span>);</span><br><span class="line">        Integer d = Integer.valueOf(<span class="number">3</span>);</span><br><span class="line">        Integer e = Integer.valueOf(<span class="number">321</span>);</span><br><span class="line">        Integer f = Integer.valueOf(<span class="number">321</span>);</span><br><span class="line">        Long g = Long.valueOf(<span class="number">3L</span>);</span><br><span class="line">        System.out.println(c == d);</span><br><span class="line">        System.out.println(e == f);</span><br><span class="line">        System.out.println(c.intValue() == a.intValue() + b.intValue());</span><br><span class="line">        System.out.println(c.equals(Integer.valueOf(a.intValue() + b.intValue())));</span><br><span class="line">        System.out.println(g.longValue() == (<span class="keyword">long</span>)(a.intValue() + b.intValue()));</span><br><span class="line">        System.out.println(g.equals(Integer.valueOf(a.intValue() + b.intValue())));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很容易拿到class文件的反编译结果。<br>可以看到，定义的所有变量 都被转化为封装类。</p>
<p>下面两条语句没有发生变化：<br>System.out.println(c == d);<br>System.out.println(e == f);</p>
<p>从下面这条语句可以看出，在进行数字的基本运算时，数字被还原为基本类型。<br>System.out.println(c.intValue() == a.intValue() + b.intValue());</p>
<p>从下面这条语句可以看出，基本类型作为equals参数时，会自动转换为包装类。<br>System.out.println(c.equals(Integer.valueOf(a.intValue() + b.intValue())));</p>
<p>从下面这条语句可以看出，当==两边的数字类型不一致时，占有字节较小的一侧会发生类型强转。<br>System.out.println(g.longValue() == (long)(a.intValue() + b.intValue()));</p>
<p>Ok，原来不太明白的话，读到这里你应该能给出这样的运行结果了吧？<br>true<br>false<br>true<br>true<br>true<br>false</p>
<p>大致说明一下为什么是这样的结果。<br>第1，2个输出的原因：<br>看一下Integer类的源码中这段代码你就明白了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public static Integer valueOf(int i) &#123;</span><br><span class="line">    if (i &gt;= IntegerCache.low &amp;&amp; i &lt;= IntegerCache.high)</span><br><span class="line">        return IntegerCache.cache[i + (-IntegerCache.low)];</span><br><span class="line">    return new Integer(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第3，4，5，你可能认为理应如此。<br>第6个输出为false，可以看下java.lang.Long#equals</p>
<p>如果你觉得你已经彻底明白了，你就错了，输出结果是这样的，还有一部分原因是class文件中的字节码技术。</p>
<h2 id="字节码"><a href="#字节码" class="headerlink" title="字节码"></a>字节码</h2><p>下面两条语句，虽然结果都是ture，但是，他们生成字节码中进行比较的指令也是不同的。<br>System.out.println(c == d);<br>System.out.println(3 == 3);</p>
<p>我们把之前class文件的字节码拿出来几段分析一下。<br>下面的字节码应以了一个常量，调用了Method java/lang/Integer.valueOf获取常量的值。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0: iconst_1</span><br><span class="line">1: invokestatic  <span class="comment">#2                  // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span></span><br><span class="line">4: astore_1</span><br></pre></td></tr></table></figure></p>
<p>下面的字节码取出c和d两个变量，使用if_acmpne指令进行对比，这个命令比较的是两个对象的引用地址。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">48: aload_3</span><br><span class="line">49: aload         4</span><br><span class="line">51: <span class="keyword">if</span>_acmpne     58</span><br></pre></td></tr></table></figure></p>
<p>下面的字节码取出c,a,b三个变量，a和b使用iadd命令相加，然后使用了if_icmpne命令比较两个变量的数值。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">83: aload_3</span><br><span class="line">84: invokevirtual <span class="comment">#8                  // Method java/lang/Integer.intValue:()I</span></span><br><span class="line">87: aload_1</span><br><span class="line">88: invokevirtual <span class="comment">#8                  // Method java/lang/Integer.intValue:()I</span></span><br><span class="line">91: aload_2</span><br><span class="line">92: invokevirtual <span class="comment">#8                  // Method java/lang/Integer.intValue:()I</span></span><br><span class="line">95: iadd</span><br><span class="line">96: <span class="keyword">if</span>_icmpne     103</span><br></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>如果想彻底了解java的数字运算，必须要知道编译后生成的class文件，甚至去查看字节码。<br>如果不想知其所以然，也可以通过下面的方式记忆。</p>
<ol>
<li>如果你定义的是基本类型，编译器会根据你定义数字的具体大小，来描述你的变量。<br>比如你定义了int a = 1;但是在程序中没有使用，那编译后生成的字节码中可能是如下的结果：<br>boolean a = true;<br>如果你使用了，可能又是下面的结果：<br>byte h = 1;</li>
<li>如果你定义的是包装类，而且是把基本类型赋值给包装类，那编译器会调用包装类的valueOf方法。</li>
<li>封装类进行基本运算都会转化成基本类型。</li>
<li>==两端，如果有一侧进行了数字运算，那么它使用if_icmpne指令来比较是否相等，也就是说比较数值大小。</li>
<li>==两端，如果两侧都没有进行数字运算，那么它使用if_acmpne指令来比较是否相等，也就是说比较的是引用地址。</li>
</ol>
<p>大概就是这样了，开发jdk的大牛们，为了jvm更高效，让我们现在会遇到各种各样奇怪的问题。<br>所以，我们在比较数字是否相等时，最好这样做：</p>
<ol>
<li>将数字转化为基本类型，使用==进行比较。</li>
<li>将数字都转化成同样类型的包装类，使用equals进行比较。</li>
</ol>
<p>PS：上面的面试题其实意义不大，会的人也可能在工作中写出很差的代码，不会的人也不一定写不出好的代码。大部分面试官看不出一个人的能力，只能量化标准。正所谓千里马常有，伯乐不常有。</p>


			
            <section class="comment">
<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="/2016/05/21/数字运算那些事/" data-title="数字运算那些事" data-url="http://wangguodong577.github.io/2016/05/21/数字运算那些事/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"wangguodong577"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0]
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->
</section>
        </div>
    </div>
</article>

    <footer id="footer">
    <div id="bottom-tip">
        Guodong
    </div>
        <small><a href="https://hexo.io/" target="_blank">Hexo</a>， <a href="https://github.com/XadillaX/hexadillax" target="_blank">Hexadillax</a> 主题</small><br />
    </footer>

    


</body>
</html>

